name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install CMake and NDK
      run: |
        yes | sdkmanager --install "ndk;26.1.10909125"
        # Install CMake 3.30.3 manually since SDK doesn't have it
        wget -q https://github.com/Kitware/CMake/releases/download/v3.30.3/cmake-3.30.3-linux-x86_64.tar.gz
        tar -xzf cmake-3.30.3-linux-x86_64.tar.gz
        sudo mv cmake-3.30.3-linux-x86_64 /opt/cmake-3.30.3
        echo "/opt/cmake-3.30.3/bin" >> $GITHUB_PATH
    
    - name: Clone Raymob template
      run: |
        git clone --recursive https://github.com/Bigfoot71/Raymob.git android-build
        rm android-build/app/src/main/cpp/main.c
        cp src/main.cpp src/game.cpp src/graphics.cpp src/story.cpp src/hacking.cpp src/systems.cpp android-build/app/src/main/cpp/
        cp src/types.hpp src/hacking.hpp android-build/app/src/main/cpp/
        mkdir -p android-build/app/src/main/assets
        cp resources/* android-build/app/src/main/assets/ || true
    
    - name: Patch main.cpp for Android
      run: |
        sed -i '1s/^/#include "raymob.h"\n/' android-build/app/src/main/cpp/main.cpp
        sed -i 's/InitWindow(W, H,/InitWindow(0, 0,/' android-build/app/src/main/cpp/main.cpp
        sed -i 's|resources/JetBrainsMono.ttf|JetBrainsMono.ttf|' android-build/app/src/main/cpp/main.cpp
        
        # Set landscape orientation
        sed -i 's/android:screenOrientation="[^"]*"/android:screenOrientation="sensorLandscape"/' android-build/app/src/main/AndroidManifest.xml
        # If not found, add it
        sed -i 's/<activity/<activity android:screenOrientation="sensorLandscape"/' android-build/app/src/main/AndroidManifest.xml
    
    - name: Fix CMake path and C++ standard
      run: |
        cmake --version
        echo "cmake.dir=/opt/cmake-3.30.3" >> android-build/local.properties
        # Set C++17 standard
        sed -i 's/set(CMAKE_CXX_STANDARD 11)/set(CMAKE_CXX_STANDARD 17)/' android-build/app/src/main/cpp/CMakeLists.txt
    
    - name: Build APK
      working-directory: android-build
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: HackerSimulator-APK
        path: android-build/app/build/outputs/apk/debug/*.apk
