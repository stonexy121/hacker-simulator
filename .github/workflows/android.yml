name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install CMake and NDK
      run: |
        yes | sdkmanager --install "cmake;3.22.1" "ndk;26.1.10909125"
    
    - name: Clone Raymob template
      run: |
        git clone https://github.com/Bigfoot71/Raymob.git android-build
        rm android-build/app/src/main/cpp/main.c
        cp src/main.cpp src/game.cpp src/graphics.cpp src/story.cpp src/hacking.cpp src/systems.cpp android-build/app/src/main/cpp/
        cp src/types.hpp src/hacking.hpp android-build/app/src/main/cpp/
        mkdir -p android-build/app/src/main/assets
        cp resources/* android-build/app/src/main/assets/ || true
    
    - name: Patch main.cpp for Android
      run: |
        sed -i '1s/^/#include "raymob.h"\n/' android-build/app/src/main/cpp/main.cpp
        sed -i 's/InitWindow(W, H,/InitWindow(0, 0,/' android-build/app/src/main/cpp/main.cpp
        sed -i 's|resources/JetBrainsMono.ttf|JetBrainsMono.ttf|' android-build/app/src/main/cpp/main.cpp
    
    - name: Build APK
      working-directory: android-build
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: HackerSimulator-APK
        path: android-build/app/build/outputs/apk/release/*.apk
